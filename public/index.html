<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë˜ì„± ê²Œì„ - Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { text-align: center; font-family: 'Malgun Gothic', sans-serif; background: #fdf5e6; margin: 0; overflow: hidden; }
        #lobby { background: white; padding: 20px; border-radius: 15px; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .rule-box { background: #fffde7; padding: 15px; border: 1px solid #ffe082; text-align: left; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.6; }
        
        #game-screen { display: none; height: 100vh; position: relative; }
        #center-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; }
        
        #sand { width: 220px; background: #edc9af; margin: 0 auto; transition: height 0.5s; border-radius: 110px 110px 0 0; position: relative; z-index: 2; }
        #stick { width: 10px; height: 160px; background: #8b4513; position: absolute; bottom: 90%; left: 105px; border-radius: 5px; transition: transform 0.05s; transform-origin: bottom; z-index: 3; }
        
        #hand { position: absolute; font-size: 50px; display: none; z-index: 10; transition: all 0.6s; left: 50%; margin-left: -25px; top: 0; }
        .hand-anim { display: block !important; animation: sweep 0.8s forwards; }
        @keyframes sweep { 0% { transform: translateX(100px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateX(-100px); opacity: 0; } }

        #prob-bar { width: 200px; height: 15px; margin: 20px auto; border-radius: 10px; background: linear-gradient(to right, blue, red); border: 2px solid white; position: relative; }
        #prob-pointer { position: absolute; top: -5px; width: 4px; height: 25px; background: black; transition: left 0.5s; }

        #side-panel { position: fixed; top: 10px; right: 10px; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd; z-index: 100; }
        .active-turn { color: red; font-weight: bold; background: #ffeb3b; }
        
        /* ì»¨íŠ¸ë¡¤ ì˜ì—­: ê²Œì„ ì¤‘ì¼ ë•Œë§Œ í‘œì‹œ */
        .controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 85%; z-index: 100; display: none; }
        
        button { padding: 10px 20px; font-size: 16px; background: #d2691e; color: white; border: none; border-radius: 10px; cursor: pointer; margin: 5px; }
        #msg { position: fixed; top: 60px; width: 100%; font-size: 22px; font-weight: bold; padding: 0 10px; box-sizing: border-box; min-height: 80px; z-index: 110; }
        
        /* ê²°ê³¼ ë° ì¬ì‹œì‘ ì˜ì—­: ê²Œì„ ì¢…ë£Œ ì‹œ ëª¨ë˜ì‚° ìœ„ìª½ì— ë°°ì¹˜ */
        #result-area { display: none; margin-bottom: 20px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 15px; width: 280px; margin-left: auto; margin-right: auto; }
        .small-btn { font-size: 14px; background: #5d4037; display: block; width: 80%; margin: 10px auto; }
    </style>
</head>
<body>

    <div id="lobby">
        <h2>â³ ëª¨ë˜ì„± ê²Œì„</h2>
        <div class="rule-box">
            <b>ğŸ“œ ê²Œì„ ê·œì¹™:</b><br>
            1. ìê¸° ì°¨ë¡€ì— ëª¨ë˜ë¥¼ 1~10ë§Œí¼ ê°€ì ¸ì˜µë‹ˆë‹¤.<br>
            2. ëª¨ë˜ë¥¼ ê°€ì ¸ì˜¤ë‹¤ ë§‰ëŒ€ë¥¼ ì“°ëŸ¬ëœ¨ë¦¬ëŠ” í”Œë ˆì´ì–´ê°€ <br>
               íŒ¨ë°°í•©ë‹ˆë‹¤. ëª¨ë˜ê°€ ì¤„ì–´ë“¤ìˆ˜ë¡ ë§‰ëŒ€ê°€ ì“°ëŸ¬ì§ˆ <br> 
               í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.<br>
            3. 5ë°”í€´ê°€ ëˆ í›„ì—ë„ ë§‰ëŒ€ê°€ ì•ˆ ì“°ëŸ¬ì§€ë©´,<br>
               ëª¨ë˜ë¥¼ ì œì¼ ì¡°ê¸ˆ ê°€ì ¸ê°„ í”Œë ˆì´ì–´ê°€ íŒ¨ë°°í•©ë‹ˆë‹¤!<br>
            4. âš ï¸ <b>ì ˆëŒ€ ìƒˆë¡œê³ ì¹¨ í•˜ì§€ ë§ˆì„¸ìš”!</b> (ì¬ì…ì¥ ë¶ˆê°€)
        </div>
        <div id="login-area">
            <input type="text" id="name-input" placeholder="ì´ë¦„ ì…ë ¥" style="padding:10px; width:60%;">
            <button onclick="join()">ì…ì¥</button>
        </div>
        <div id="waiting-area" style="display:none;">
            <div id="player-list"></div>
            <button id="start-btn" style="display:none;" onclick="socket.emit('startGame', 'all')">ê²Œì„ ì‹œì‘!</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="side-panel"><b>ìˆœì„œ</b><div id="order-list"></div></div>
        <div id="msg">ì¤€ë¹„í•˜ì„¸ìš”!</div>
        
        <div id="center-container">
            <div id="hand">âœ‹</div>
            
            <div id="result-area">
                <div id="final-results" style="font-size:14px; margin-bottom:10px;"></div>
                <div id="restart-buttons" style="display:none;">
                    <button class="small-btn" onclick="socket.emit('startGame', 'all')">ì „ì› ë‹¤ì‹œí•˜ê¸°</button>
                    <button class="small-btn" onclick="socket.emit('startGame', 'excludeLoser')">íŒ¨ë°°ì ì œì™¸í•˜ê³  í•˜ê¸°</button>
                </div>
            </div>

            <div id="sand"><div id="stick"></div></div>
            <div id="prob-bar"><div id="prob-pointer"></div></div>
        </div>
        
        <div class="controls" id="ui">
            <p>ê°€ì ¸ê°ˆ ì–‘: <b id="v">5</b></p>
            <input type="range" min="1" max="10" value="5" id="range" style="width:100%" oninput="document.getElementById('v').innerText=this.value">
            <br><br>
            <button onclick="take()">ëª¨ë˜ ê°€ì ¸ì˜¤ê¸°</button>
        </div>
    </div>

    <script>
        const socket = io();
        let totalS = 100;
        let isGameActive = false; // [2ë²ˆ] ê²Œì„ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” ë³€ìˆ˜ ì¶”ê°€

        function join() {
            const val = document.getElementById('name-input').value;
            if(!val) return;
            socket.emit('joinGame', val);
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
        }

        socket.on('playerUpdate', (ps) => {
            document.getElementById('player-list').innerHTML = ps.map(p => `<div>ğŸ‘¤ ${p.name}</div>`).join('');
            if(ps.length > 0 && ps[0].id === socket.id) {
                document.getElementById('start-btn').style.display = 'inline-block';
            }
        });

        socket.on('gameBegin', (data) => {
            totalS = data.totalSand;
            isGameActive = true; // ê²Œì„ í™œì„±í™”
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            updateUI(data.sand, data.currentTurn, data.order);
        });

        socket.on('updateState', (data) => {
            if(!isGameActive) return; // [2ë²ˆ] ê²Œì„ ëë‚¬ìœ¼ë©´ ì‹¤í–‰ ì•ˆí•¨
            
            const hand = document.getElementById('hand');
            hand.className = 'hand-anim';
            setTimeout(() => { hand.className = ''; }, 800);
            
            shakeStick(data.chance);
            
            setTimeout(() => {
                if(isGameActive) updateUI(data.sand, data.currentTurn);
            }, 1800);
        });

        function shakeStick(chance) {
            const stick = document.getElementById('stick');
            const shakeCount = 20 + (chance * 40); 
            const intensity = 2 + (chance * 15);
            
            let count = 0;
            const interval = setInterval(() => {
                const angle = (Math.random() - 0.5) * intensity;
                stick.style.transform = `rotate(${angle}deg)`;
                count++;
                if(count > shakeCount) {
                    clearInterval(interval);
                    stick.style.transform = `rotate(0deg)`;
                }
            }, 50);
        }

        function updateUI(sand, currentTurnId, order = null) {
            if(!isGameActive) return;

            document.getElementById('sand').style.height = (sand * 1.5) + 'px';
            const chance = (totalS - sand) / totalS;
            document.getElementById('prob-pointer').style.left = (chance * 100) + '%';

            if (order) {
                document.getElementById('order-list').innerHTML = order.map(p => `<div id="p-${p.id}">${p.name}</div>`).join('');
            }
            const ops = document.getElementById('order-list').children;
            for (let el of ops) el.className = el.id === `p-${currentTurnId}` ? 'active-turn' : '';

            const myTurn = currentTurnId === socket.id;
            document.getElementById('msg').innerText = myTurn ? "ğŸ“¢ ë‚´ ì°¨ë¡€!" : "âŒ› ëŒ€ê¸° ì¤‘...";
            
            // [2ë²ˆ] ë‚´ ì°¨ë¡€ì—¬ë„ ê²Œì„ì´ í™œì„± ìƒíƒœì¼ ë•Œë§Œ UIë¥¼ ë³´ì—¬ì¤Œ
            document.getElementById('ui').style.display = myTurn ? 'block' : 'none';
        }

        function take() {
            socket.emit('takeSand', parseInt(document.getElementById('range').value));
        }

        socket.on('gameOver', (data) => {
            isGameActive = false; // [2ë²ˆ] ê²Œì„ ë¹„í™œì„±í™” (ë²„ê·¸ ë°©ì§€)
            
            // ìƒë‹¨ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            document.getElementById('msg').innerHTML = `<span style="color:red">ğŸ’¥ íŒ¨ë°°: ${data.loserName}</span>`;
            
            // [1ë²ˆ] ì¤‘ì•™ ê²°ê³¼ì°½ í‘œì‹œ ë° ë‚´ìš© ì‚½ì…
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('final-results').innerHTML = `<b>ğŸ“Š ìµœì¢… íšë“ëŸ‰</b><br>${data.results}`;
            
            // ë‚˜ë¬´ë§‰ëŒ€ ì“°ëŸ¬ì§ ì—°ì¶œ
            document.getElementById('stick').style.transform = "rotate(90deg) translateY(50px)";
            
            // [2ë²ˆ] ìŠ¬ë¼ì´ë“œ UI ì¦‰ì‹œ ìˆ¨ê¹€
            document.getElementById('ui').style.display = 'none';
            
            // ë°©ì¥ì—ê²Œë§Œ ì¬ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
            if (data.hostId === socket.id) {
                document.getElementById('restart-buttons').style.display = 'block';
            }
        });
    </script>
</body>
</html>

