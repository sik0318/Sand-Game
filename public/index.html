<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë˜ì„± ê²Œì„ - Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { text-align: center; font-family: 'Malgun Gothic', sans-serif; background: #fdf5e6; margin: 0; overflow: hidden; }
        #lobby { background: white; padding: 20px; border-radius: 15px; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .rule-box { background: #fffde7; padding: 15px; border: 1px solid #ffe082; text-align: left; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.6; }
        
        /* [2ë²ˆ] í™”ë©´ ì¤‘ì•™ ë°°ì¹˜ */
        #game-screen { display: none; height: 100vh; position: relative; }
        #center-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        #sand { width: 220px; background: #edc9af; margin: 0 auto; transition: height 0.5s; border-radius: 110px 110px 0 0; position: relative; z-index: 2; }
        #stick { width: 10px; height: 160px; background: #8b4513; position: absolute; bottom: 90%; left: 105px; border-radius: 5px; transition: transform 0.1s; transform-origin: bottom; z-index: 3; }
        
        /* [3ë²ˆ] ì† ì• ë‹ˆë©”ì´ì…˜ */
        #hand { position: absolute; font-size: 50px; display: none; z-index: 10; transition: all 0.6s; }
        @keyframes sweep { 0% { transform: translateX(100px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateX(-100px); opacity: 0; } }
        .hand-anim { display: block !important; animation: sweep 0.8s forwards; }

        /* [4ë²ˆ] í™•ë¥  ê·¸ë¼ë°ì´ì…˜ ë°” */
        #prob-bar { width: 200px; height: 15px; margin: 20px auto; border-radius: 10px; background: linear-gradient(to right, blue, red); border: 2px solid white; position: relative; }
        #prob-pointer { position: absolute; top: -5px; width: 4px; height: 25px; background: black; transition: left 0.5s; }

        #side-panel { position: fixed; top: 10px; right: 10px; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd; z-index: 100; }
        .active-turn { color: red; font-weight: bold; background: #ffeb3b; }
        .controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 85%; z-index: 100; }
        
        button { padding: 15px 30px; font-size: 18px; background: #d2691e; color: white; border: none; border-radius: 10px; cursor: pointer; }
        #msg { position: fixed; top: 80px; width: 100%; font-size: 22px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lobby">
        <h2>â³ ëª¨ë˜ì„± ê²Œì„</h2>
        <div class="rule-box">
            <b>ğŸ“œ ê²Œì„ ê·œì¹™ (í•„ë…):</b><br>
            1. ìê¸° ì°¨ë¡€ì— ëª¨ë˜ë¥¼ 1~10ë§Œí¼ ê°€ì ¸ì˜µë‹ˆë‹¤.<br>
            2. ëª¨ë˜ê°€ ì¤„ìˆ˜ë¡ ë§‰ëŒ€ê°€ ì“°ëŸ¬ì§ˆ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.<br>
            3. [7ë²ˆ] <b>ê°ì 5ë²ˆì˜ ì°¨ë¡€ê°€ ì§€ë‚  ë•Œê¹Œì§€ ë§‰ëŒ€ê°€ ì•ˆ ì“°ëŸ¬ì§€ë©´, ëª¨ë˜ë¥¼ ê°€ì¥ ì ê²Œ ê°€ì ¸ê°„ ì‚¬ëŒì´ íŒ¨ë°°í•©ë‹ˆë‹¤!</b><br>
            4. [8ë²ˆ] <b>âš ï¸ ì£¼ì˜: ì ˆëŒ€ ìƒˆë¡œê³ ì¹¨ í•˜ì§€ ë§ˆì„¸ìš”!</b> (ì—°ê²°ì´ ëŠê¹ë‹ˆë‹¤)
        </div>
        <div id="login-area">
            <input type="text" id="name-input" placeholder="ì´ë¦„ ì…ë ¥" style="padding:10px; width:60%;">
            <button onclick="join()">ì…ì¥</button>
        </div>
        <div id="waiting-area" style="display:none;">
            <div id="player-list"></div>
            <button id="start-btn" style="display:none; margin-top:15px;" onclick="socket.emit('startGame')">ê²Œì„ ì‹œì‘!</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="side-panel"><b>ìˆœì„œ</b><div id="order-list"></div></div>
        <div id="msg">ì¤€ë¹„í•˜ì„¸ìš”!</div>
        
        <div id="center-container">
            <div id="hand">âœ‹</div>
            <div id="sand"><div id="stick"></div></div>
            <div id="prob-bar"><div id="prob-pointer" id="pointer"></div></div>
            <div style="font-size: 12px; color: #666;">ë„˜ì–´ì§ˆ í™•ë¥  (ì•ˆì „ â†” ìœ„í—˜)</div>
        </div>
        
        <div class="controls" id="ui" style="display:none;">
            <p>ê°€ì ¸ê°ˆ ì–‘: <b id="v">5</b></p>
            <input type="range" min="1" max="10" value="5" id="range" style="width:100%" oninput="document.getElementById('v').innerText=this.value">
            <br><br>
            <button onclick="take()">ëª¨ë˜ ê°€ì ¸ì˜¤ê¸°</button>
        </div>
    </div>

    <script>
        const socket = io();
        let totalS = 100;

        function join() {
            const val = document.getElementById('name-input').value;
            if(!val) return;
            socket.emit('joinGame', val);
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
        }

        socket.on('playerUpdate', (ps) => {
            document.getElementById('player-list').innerHTML = ps.map(p => `<div>ğŸ‘¤ ${p.name}</div>`).join('');
            if(ps[0].id === socket.id) document.getElementById('start-btn').style.display = 'inline-block';
        });

        socket.on('gameBegin', (data) => {
            totalS = data.totalSand;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            updateUI(data.sand, data.currentTurn, data.order);
        });

        socket.on('updateState', (data) => {
            // [3ë²ˆ] ì† ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            const hand = document.getElementById('hand');
            hand.className = 'hand-anim';
            setTimeout(() => { hand.className = ''; }, 800);
            
            // [9ë²ˆ] ê¸´ì¥ê° ìˆëŠ” í”ë“¤ë¦¼ ì—°ì¶œ
            shakeStick(data.chance);
            
            setTimeout(() => {
                updateUI(data.sand, data.currentTurn);
            }, 1000);
        });

        function shakeStick(chance) {
            const stick = document.getElementById('stick');
            const shakeCount = 5 + (chance * 20); // í™•ë¥  ë†’ì„ìˆ˜ë¡ ë” ë§ì´ í”ë“¤ë¦¼
            const intensity = 2 + (chance * 15);  // í™•ë¥  ë†’ì„ìˆ˜ë¡ ë” í¬ê²Œ í”ë“¤ë¦¼
            
            let count = 0;
            const interval = setInterval(() => {
                const angle = (Math.random() - 0.5) * intensity;
                stick.style.transform = `rotate(${angle}deg)`;
                count++;
                if(count > shakeCount) {
                    clearInterval(interval);
                    stick.style.transform = `rotate(0deg)`;
                }
            }, 50);
        }

        function updateUI(sand, currentTurnId, order = null) {
            document.getElementById('sand').style.height = (sand * 1.5) + 'px';
            
            // [4ë²ˆ] í™•ë¥  í¬ì¸í„° ìœ„ì¹˜ ê³„ì‚°
            const chance = (totalS - sand) / totalS;
            document.getElementById('prob-pointer').style.left = (chance * 100) + '%';

            if (order) {
                document.getElementById('order-list').innerHTML = order.map(p => `<div id="p-${p.id}">${p.name}</div>`).join('');
            }
            const ops = document.getElementById('order-list').children;
            for (let el of ops) el.className = el.id === `p-${currentTurnId}` ? 'active-turn' : '';

            const myTurn = currentTurnId === socket.id;
            document.getElementById('msg').innerText = myTurn ? "ğŸ“¢ ë‚´ ì°¨ë¡€!" : "âŒ› ëŒ€ê¸° ì¤‘...";
            document.getElementById('ui').style.display = myTurn ? 'block' : 'none';
        }

        function take() {
            socket.emit('takeSand', parseInt(document.getElementById('range').value));
        }

        socket.on('gameOver', (data) => {
            document.getElementById('msg').innerHTML = `<span style="color:red">ğŸ’¥ íŒ¨ë°°: ${data.loserName}</span><br><small>${data.reason}</small><br><div style="font-size:14px; margin-top:10px;">${data.results}</div>`;
            document.getElementById('stick').style.transform = "rotate(90deg) translateY(50px)";
            document.getElementById('ui').style.display = 'none';
        });
    </script>
</body>
</html>
