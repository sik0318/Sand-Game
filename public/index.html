<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë˜ì„± ê²Œì„ - ë©€í‹°í”Œë ˆì´</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { text-align: center; font-family: 'Malgun Gothic', sans-serif; background: #fdf5e6; margin: 0; padding: 10px; }
        /* ëŒ€ê¸°ì‹¤ ìŠ¤íƒ€ì¼ */
        #lobby { background: white; padding: 20px; border-radius: 15px; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .rule-box { background: #fffde7; padding: 10px; border: 1px solid #ffe082; text-align: left; font-size: 0.9rem; margin-bottom: 20px; }
        /* ê²Œì„ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #game-screen { display: none; }
        #sand { width: 180px; background: #edc9af; margin: 50px auto; transition: 0.5s; border-radius: 90px 90px 0 0; position: relative; }
        #stick { width: 8px; height: 120px; background: #8b4513; position: absolute; bottom: 80%; left: 86px; transition: 0.5s; transform-origin: bottom; }
        /* ìˆœì„œ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        #side-panel { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 10px; text-align: left; font-size: 0.8rem; border: 1px solid #ddd; }
        .active-turn { color: red; font-weight: bold; background: #ffeb3b; }
        .controls { background: white; padding: 15px; border-radius: 15px; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; font-size: 16px; background: #d2691e; color: white; border: none; border-radius: 5px; cursor: pointer; }
        input[type=text] { padding: 10px; width: 70%; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="lobby">
        <h2>â³ ëª¨ë˜ì„± ê²Œì„ ëŒ€ê¸°ì‹¤</h2>
        <div class="rule-box">
            <b>ğŸ“œ ê²Œì„ ê·œì¹™:</b><br>
            1. ìê¸° ì°¨ë¡€ì— ëª¨ë˜ë¥¼ 1~10ë§Œí¼ ê°€ì ¸ì˜µë‹ˆë‹¤.<br>
            2. ëª¨ë˜ê°€ ì¤„ì–´ë“¤ìˆ˜ë¡ ë‚˜ë­‡ê°€ì§€ê°€ ì“°ëŸ¬ì§ˆ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.<br>
            3. ë‚˜ë­‡ê°€ì§€ë¥¼ ì“°ëŸ¬ëœ¨ë¦¬ëŠ” ì‚¬ëŒì´ íŒ¨ë°°í•©ë‹ˆë‹¤!
        </div>
        <div id="login-area">
            <input type="text" id="name-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="join()">ì…ì¥í•˜ê¸°</button>
        </div>
        <div id="waiting-area" style="display:none;">
            <h4>í˜„ì¬ ì ‘ì†ì:</h4>
            <div id="player-list"></div>
            <br>
            <button id="start-btn" style="display:none;" onclick="socket.emit('startGame')">ê²Œì„ ì‹œì‘í•˜ê¸°!</button>
            <p id="host-msg" style="color: #666; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="game-screen">
        <div id="side-panel">
            <b>ğŸƒ ìˆœì„œ</b>
            <div id="order-list"></div>
        </div>
        <h2 id="msg">ì¤€ë¹„í•˜ì„¸ìš”!</h2>
        <div id="sand"><div id="stick"></div></div>
        
        <div class="controls" id="ui" style="display:none;">
            <p>ê°€ì ¸ê°ˆ ì–‘: <span id="v">5</span></p>
            <input type="range" min="1" max="10" value="5" id="range" style="width:100%" oninput="document.getElementById('v').innerText=this.value">
            <br><br>
            <button onclick="take()">ëª¨ë˜ ê°€ì ¸ì˜¤ê¸°</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = "";

        // ì…ì¥í•˜ê¸°
        function join() {
            const input = document.getElementById('name-input');
            if(!input.value) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            myName = input.value;
            socket.emit('joinGame', myName);
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
        }

        socket.on('playerUpdate', (players) => {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => `<div>ğŸ‘¤ ${p.name} ${p.host ? '(ë°©ì¥)' : ''}</div>`).join('');
            
            const me = players.find(p => p.id === socket.id);
            if (me && me.host) {
                document.getElementById('start-btn').style.display = 'inline-block';
                document.getElementById('host-msg').innerText = "ë‹¹ì‹ ì€ ë°©ì¥ì…ë‹ˆë‹¤. ì¸ì›ì´ ëª¨ì´ë©´ ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš”.";
            } else {
                document.getElementById('host-msg').innerText = "ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...";
            }
        });

        // ê²Œì„ ì‹œì‘ ì‹œ í™”ë©´ ì „í™˜
        socket.on('gameBegin', (data) => {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            updateUI(data.sand, data.currentTurn, data.order);
        });

        socket.on('updateState', (data) => {
            updateUI(data.sand, data.currentTurn);
        });

        function updateUI(sand, currentTurnId, order = null) {
            document.getElementById('sand').style.height = (sand * 1.5) + 'px'; // ì‹œê°ì ìœ¼ë¡œ ì¢€ ë” í¬ê²Œ
            document.getElementById('stick').style.transform = `rotate(${(100-sand)/3}deg)`;
            
            // ìˆœì„œ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (order) {
                const orderDiv = document.getElementById('order-list');
                orderDiv.innerHTML = order.map(p => `<div id="p-${p.id}">${p.name}</div>`).join('');
            }

            // í˜„ì¬ ìˆœì„œ ê°•ì¡°
            const orderList = document.getElementById('order-list').children;
            for (let el of orderList) {
                el.className = el.id === `p-${currentTurnId}` ? 'active-turn' : '';
            }

            const myTurn = currentTurnId === socket.id;
            document.getElementById('msg').innerText = myTurn ? "ğŸ“¢ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤!" : "âŒ› ìƒëŒ€ë°© ì°¨ë¡€...";
            document.getElementById('ui').style.display = myTurn ? 'block' : 'none';
        }

        function take() {
            const val = parseInt(document.getElementById('range').value);
            socket.emit('takeSand', val);
        }

        socket.on('gameOver', (data) => {
            document.getElementById('msg').innerText = `ğŸ’¥ ${data.loserName}ë‹˜ì´ ë‚˜ë­‡ê°€ì§€ë¥¼ ì“°ëŸ¬ëœ¨ë ¸ìŠµë‹ˆë‹¤!`;
            document.getElementById('stick').style.transform = "rotate(90deg)";
            document.getElementById('ui').style.display = 'none';
        });
    </script>
</body>
</html>
